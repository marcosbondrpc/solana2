groups:
  - name: arbitrage_system_alerts
    interval: 30s
    rules:
      # High-level system alerts
      - alert: SystemDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "System component {{ $labels.job }} is down"
          description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 1 minute."

      # ClickHouse alerts
      - alert: ClickHouseHighQueryLatency
        expr: rate(clickhouse_query_duration_seconds[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          component: clickhouse
        annotations:
          summary: "ClickHouse query latency is high"
          description: "ClickHouse query latency is above 500ms for 5 minutes (current value: {{ $value }}s)"

      - alert: ClickHouseReplicationLag
        expr: clickhouse_replication_lag_seconds > 10
        for: 5m
        labels:
          severity: warning
          component: clickhouse
        annotations:
          summary: "ClickHouse replication lag detected"
          description: "Replication lag is {{ $value }} seconds"

      - alert: ClickHouseDiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/var/lib/clickhouse"} / node_filesystem_size_bytes{mountpoint="/var/lib/clickhouse"}) < 0.1
        for: 5m
        labels:
          severity: critical
          component: clickhouse
        annotations:
          summary: "ClickHouse disk space critically low"
          description: "Less than 10% disk space remaining on ClickHouse data directory"

      # Kafka alerts
      - alert: KafkaConsumerLag
        expr: kafka_consumer_lag > 10000
        for: 5m
        labels:
          severity: warning
          component: kafka
        annotations:
          summary: "Kafka consumer lag is high"
          description: "Consumer group {{ $labels.consumergroup }} has lag of {{ $value }} messages"

      - alert: KafkaBrokerDown
        expr: kafka_brokers < 3
        for: 1m
        labels:
          severity: critical
          component: kafka
        annotations:
          summary: "Kafka broker down"
          description: "Number of active Kafka brokers is {{ $value }}, expected 3"

      - alert: KafkaTopicUnderReplicated
        expr: kafka_topic_under_replicated_partitions > 0
        for: 5m
        labels:
          severity: warning
          component: kafka
        annotations:
          summary: "Kafka topic under-replicated"
          description: "Topic {{ $labels.topic }} has {{ $value }} under-replicated partitions"

      # API performance alerts
      - alert: APIHighLatency
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API p99 latency above 1 second"
          description: "99th percentile API latency is {{ $value }} seconds"

      - alert: APIHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "API error rate above 5%"
          description: "API 5xx error rate is {{ $value | humanizePercentage }}"

      - alert: APIRateLimitExceeded
        expr: rate(rate_limit_exceeded_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API rate limits being exceeded"
          description: "Rate limit exceeded {{ $value }} times per second"

      # Data processing alerts
      - alert: ArbitrageDetectionSlow
        expr: arbitrage_detection_latency_ms > 100
        for: 5m
        labels:
          severity: warning
          component: processor
        annotations:
          summary: "Arbitrage detection exceeding 100ms"
          description: "Detection latency is {{ $value }}ms, target is <50ms"

      - alert: LowArbitrageOpportunities
        expr: rate(arbitrage_opportunities_detected_total[1h]) < 10
        for: 30m
        labels:
          severity: info
          component: processor
        annotations:
          summary: "Low arbitrage opportunity detection rate"
          description: "Only {{ $value }} opportunities per second detected in last hour"

      - alert: HighProcessingBacklog
        expr: processing_queue_size > 50000
        for: 5m
        labels:
          severity: warning
          component: processor
        annotations:
          summary: "Processing queue backlog is high"
          description: "{{ $value }} messages waiting in processing queue"

      # Redis alerts
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Redis memory usage above 90%"
          description: "Redis is using {{ $value | humanizePercentage }} of max memory"

      - alert: RedisReplicationBroken
        expr: redis_connected_slaves < 1
        for: 5m
        labels:
          severity: critical
          component: redis
        annotations:
          summary: "Redis replication broken"
          description: "Redis master has {{ $value }} connected replicas, expected at least 1"

      # System resource alerts
      - alert: HighCPUUsage
        expr: (100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }}"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs|squashfs|vfat"} / node_filesystem_size_bytes) < 0.15
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "Low disk space"
          description: "Only {{ $value | humanizePercentage }} disk space left on {{ $labels.device }}"

      # Business metrics alerts
      - alert: LowProfitability
        expr: avg_over_time(arbitrage_profit_usd[1h]) < 100
        for: 1h
        labels:
          severity: info
          component: business
        annotations:
          summary: "Low profitability detected"
          description: "Average profit in last hour is ${{ $value }}"

      - alert: HighGasCosts
        expr: (arbitrage_gas_cost_total / arbitrage_profit_total) > 0.5
        for: 30m
        labels:
          severity: warning
          component: business
        annotations:
          summary: "Gas costs exceeding 50% of profits"
          description: "Gas costs are {{ $value | humanizePercentage }} of total profits"

      - alert: LowSuccessRate
        expr: (arbitrage_successful_total / arbitrage_attempted_total) < 0.7
        for: 30m
        labels:
          severity: warning
          component: business
        annotations:
          summary: "Arbitrage success rate below 70%"
          description: "Success rate is {{ $value | humanizePercentage }}"

      # ML Pipeline alerts
      - alert: MLFeatureExtractionSlow
        expr: ml_feature_extraction_duration_seconds > 1
        for: 5m
        labels:
          severity: warning
          component: ml_pipeline
        annotations:
          summary: "ML feature extraction taking too long"
          description: "Feature extraction taking {{ $value }} seconds"

      - alert: MLDataQualityIssue
        expr: ml_data_quality_score < 0.8
        for: 15m
        labels:
          severity: warning
          component: ml_pipeline
        annotations:
          summary: "ML data quality below threshold"
          description: "Data quality score is {{ $value }}, threshold is 0.8"